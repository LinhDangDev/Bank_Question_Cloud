<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Exam Export</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîß Debug Exam Word Export</h1>
    <p><strong>Author:</strong> Linh Dang Dev</p>

    <div class="test-section">
        <h3>üìã Configuration</h3>
        <label for="examId">Exam ID:</label>
        <input type="text" id="examId" value="D5311678-1D22-40A3-8124-D6CDC34512AE" />
        
        <label for="apiBase">API Base URL:</label>
        <input type="text" id="apiBase" value="http://localhost:3000/api" />
    </div>

    <div class="test-section">
        <h3>üß™ Tests</h3>
        <button onclick="testBackendConnection()">Test Backend Connection</button>
        <button onclick="testDefaultOptions()">Test Default Options</button>
        <button onclick="testPythonExport()">Test Python Export</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-section">
        <h3>üìã Debug Log</h3>
        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            logDiv.innerHTML += `<div style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'black'}">[${timestamp}] ${icon} ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testBackendConnection() {
            const apiBase = document.getElementById('apiBase').value;
            log('Testing backend connection...');
            
            try {
                const response = await fetch(`${apiBase}/exam-word-export/templates`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log('Backend connection successful', 'success');
                    log(`Templates available: ${data.data.templates.length}`);
                } else {
                    log(`Backend connection failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`Backend connection error: ${error.message}`, 'error');
            }
        }

        async function testDefaultOptions() {
            const apiBase = document.getElementById('apiBase').value;
            const examId = document.getElementById('examId').value;
            
            if (!examId) {
                log('Please enter Exam ID', 'error');
                return;
            }
            
            log(`Testing default options for exam: ${examId}...`);
            
            try {
                const response = await fetch(`${apiBase}/exam-word-export/${examId}/default-options`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log('Default options loaded successfully', 'success');
                    log(`Exam title: ${data.data.examTitle}`);
                    log(`Subject: ${data.data.subject}`);
                } else {
                    log(`Default options failed: ${data.message || 'Unknown error'}`, 'error');
                    log(`Response status: ${response.status}`);
                }
            } catch (error) {
                log(`Default options error: ${error.message}`, 'error');
            }
        }

        async function testPythonExport() {
            const apiBase = document.getElementById('apiBase').value;
            const examId = document.getElementById('examId').value;
            
            if (!examId) {
                log('Please enter Exam ID', 'error');
                return;
            }
            
            log(`Testing Python export for exam: ${examId}...`);
            
            const exportOptions = {
                examTitle: 'ƒê·ªÄ THI DEBUG TEST',
                subject: 'C∆° s·ªü d·ªØ li·ªáu',
                course: 'Khoa CNTT',
                semester: 'H·ªçc k·ª≥ 1',
                academicYear: '2024-2025',
                examDate: new Date().toLocaleDateString('vi-VN'),
                duration: '90 ph√∫t',
                instructions: 'Th·ªùi gian l√†m b√†i: 90 ph√∫t. Kh√¥ng ƒë∆∞·ª£c s·ª≠ d·ª•ng t√†i li·ªáu.',
                allowMaterials: false,
                showAnswers: false,
                separateAnswerSheet: false,
                studentInfo: {
                    studentId: '',
                    studentName: '',
                    className: ''
                }
            };

            log(`Export options: ${JSON.stringify(exportOptions, null, 2)}`);
            
            try {
                const response = await fetch(`${apiBase}/exam-word-export/${examId}/export-python`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(exportOptions)
                });

                log(`Response status: ${response.status}`);
                log(`Response headers: ${JSON.stringify([...response.headers.entries()])}`);

                if (response.ok) {
                    const blob = await response.blob();
                    log(`Python export successful! File size: ${blob.size} bytes`, 'success');
                    
                    // Download file
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `debug_export_${Date.now()}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    log('File downloaded successfully', 'success');
                } else {
                    const errorText = await response.text();
                    log(`Python export failed: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`Python export error: ${error.message}`, 'error');
            }
        }

        // Auto-run backend test on load
        window.onload = function() {
            log('Debug page loaded');
            testBackendConnection();
        };
    </script>
</body>
</html>
