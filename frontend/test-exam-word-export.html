<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Exam Word Export</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Exam Word Export API</h1>
    <p><strong>Author:</strong> Linh Dang Dev</p>

    <div class="test-section">
        <h3>üìã Exam ID Configuration</h3>
        <label for="examId">Exam ID:</label>
        <input type="text" id="examId" placeholder="Nh·∫≠p exam ID t·ª´ URL trang chi ti·∫øt ƒë·ªÅ thi" />
        <button onclick="setExamId()">Set Exam ID</button>
        <div id="currentExamId" class="result"></div>
    </div>

    <div class="test-section">
        <h3>üîß Test API Endpoints</h3>
        <button onclick="testTemplates()">Test Templates API</button>
        <button onclick="testDefaultOptions()">Test Default Options</button>
        <button onclick="testPreview()">Test Preview</button>
        <button onclick="testExport()">Test Export Word</button>
        <div id="apiResults"></div>
    </div>

    <div class="test-section">
        <h3>üì§ Export Options</h3>
        <label for="examTitle">Exam Title:</label>
        <input type="text" id="examTitle" value="ƒê·ªÄ THI TEST API" />
        
        <label for="subject">Subject:</label>
        <input type="text" id="subject" value="Test Subject" />
        
        <label for="course">Course:</label>
        <input type="text" id="course" value="Test Course" />
        
        <label>
            <input type="checkbox" id="showAnswers" /> Show Answers
        </label>
        
        <label>
            <input type="checkbox" id="separateAnswerSheet" /> Separate Answer Sheet
        </label>
    </div>

    <script>
        let currentExamId = '';
        const API_BASE = 'http://localhost:3000/api';

        function setExamId() {
            const examId = document.getElementById('examId').value.trim();
            if (examId) {
                currentExamId = examId;
                document.getElementById('currentExamId').innerHTML = 
                    `<div class="success">‚úÖ Current Exam ID: ${examId}</div>`;
            } else {
                document.getElementById('currentExamId').innerHTML = 
                    `<div class="error">‚ùå Please enter a valid Exam ID</div>`;
            }
        }

        function showResult(message, isSuccess = true) {
            const resultsDiv = document.getElementById('apiResults');
            const resultClass = isSuccess ? 'success' : 'error';
            const icon = isSuccess ? '‚úÖ' : '‚ùå';
            
            resultsDiv.innerHTML += `<div class="result ${resultClass}">${icon} ${message}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function testTemplates() {
            try {
                showResult('Testing templates API...');
                const response = await fetch(`${API_BASE}/exam-word-export/templates`);
                const data = await response.json();
                
                if (data.success) {
                    showResult(`Templates loaded: ${data.data.templates.length} templates found`);
                    data.data.templates.forEach(template => {
                        showResult(`  - ${template.name}: ${template.description}`);
                    });
                } else {
                    showResult(`Templates API failed: ${data.message}`, false);
                }
            } catch (error) {
                showResult(`Templates API error: ${error.message}`, false);
            }
        }

        async function testDefaultOptions() {
            if (!currentExamId) {
                showResult('Please set Exam ID first', false);
                return;
            }

            try {
                showResult(`Testing default options for exam: ${currentExamId}...`);
                const response = await fetch(`${API_BASE}/exam-word-export/${currentExamId}/default-options`);
                const data = await response.json();
                
                if (data.success) {
                    showResult('Default options loaded successfully');
                    Object.entries(data.data).forEach(([key, value]) => {
                        showResult(`  ${key}: ${value}`);
                    });
                    
                    // Auto-fill form
                    document.getElementById('examTitle').value = data.data.examTitle || 'ƒê·ªÄ THI TEST';
                    document.getElementById('subject').value = data.data.subject || 'Test Subject';
                } else {
                    showResult(`Default options failed: ${data.message}`, false);
                }
            } catch (error) {
                showResult(`Default options error: ${error.message}`, false);
            }
        }

        async function testPreview() {
            if (!currentExamId) {
                showResult('Please set Exam ID first', false);
                return;
            }

            try {
                showResult(`Testing preview for exam: ${currentExamId}...`);
                const response = await fetch(`${API_BASE}/exam-word-export/${currentExamId}/preview`);
                const data = await response.json();
                
                if (data.success) {
                    showResult(`Preview loaded: ${data.data.totalQuestions} questions`);
                    showResult(`Exam title: ${data.data.examTitle}`);
                    showResult(`Subject: ${data.data.subject}`);
                } else {
                    showResult(`Preview failed: ${data.message}`, false);
                }
            } catch (error) {
                showResult(`Preview error: ${error.message}`, false);
            }
        }

        async function testExport() {
            if (!currentExamId) {
                showResult('Please set Exam ID first', false);
                return;
            }

            try {
                const exportOptions = {
                    examTitle: document.getElementById('examTitle').value,
                    subject: document.getElementById('subject').value,
                    course: document.getElementById('course').value,
                    semester: 'H·ªçc k·ª≥ 1',
                    academicYear: '2024-2025',
                    examDate: new Date().toLocaleDateString('vi-VN'),
                    duration: '90 ph√∫t',
                    instructions: 'Th·ªùi gian l√†m b√†i: 90 ph√∫t. Kh√¥ng ƒë∆∞·ª£c s·ª≠ d·ª•ng t√†i li·ªáu.',
                    allowMaterials: false,
                    showAnswers: document.getElementById('showAnswers').checked,
                    separateAnswerSheet: document.getElementById('separateAnswerSheet').checked,
                    studentInfo: {
                        studentId: '',
                        studentName: '',
                        className: ''
                    }
                };

                showResult(`Testing export for exam: ${currentExamId}...`);
                showResult(`Export options: ${JSON.stringify(exportOptions, null, 2)}`);

                const response = await fetch(`${API_BASE}/exam-word-export/${currentExamId}/export`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(exportOptions)
                });

                if (response.ok) {
                    const blob = await response.blob();
                    showResult(`Export successful! File size: ${blob.size} bytes`);
                    
                    // Download file
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `test_export_${Date.now()}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showResult('File downloaded successfully!');
                } else {
                    const errorData = await response.json();
                    showResult(`Export failed: ${errorData.message}`, false);
                }
            } catch (error) {
                showResult(`Export error: ${error.message}`, false);
            }
        }

        // Auto-test templates on load
        window.onload = function() {
            showResult('üöÄ Test page loaded. Testing templates API...');
            testTemplates();
        };
    </script>
</body>
</html>
